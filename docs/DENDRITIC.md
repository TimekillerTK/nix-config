# Dendritic Nix for this repository <!-- omit in toc -->

- [Creating a New NixOS Host Configuration](#creating-a-new-nixos-host-configuration)
  - [Using the Dendritic pattern](#using-the-dendritic-pattern)
  - [Normal Nix Flake](#normal-nix-flake)
- [Installing/Deploying a Host](#installingdeploying-a-host)
  - [Using the Dendritic pattern](#using-the-dendritic-pattern-1)
  - [Normal Nix Flake](#normal-nix-flake-1)

This document describes how this repository uses the **dendritic pattern** to structure nix configs for NixOS hosts, home-manager configurations, and reusable features.

Nix configs using the **dendritic pattern** can differ user to user, as it's more a set of guidelines rather than a strict set of rules.

Case in point, while this repository was created based on [Dendritic Design with Flake Parts](https://github.com/Doc-Steve/dendritic-design-with-flake-parts), not all the same flake inputs are used in my config:

- ✅️ [flake-parts](https://flake.parts/)
- ✅️ [pkgs-by-name-for-flake-parts](https://github.com/drupol/pkgs-by-name-for-flake-parts)
- ✅️ [import-tree](https://github.com/vic/import-tree)
- ✅️ [home-manager](https://github.com/nix-community/home-manager/)
- ❌️ [determinate flake-hub](https://flakehub.com/flake/DeterminateSystems/determinate) - not used
- ❌️ [flake-file](https://github.com/vic/flake-file) - not used
- ❌️ [agenix](https://github.com/ryantm/agenix) - using [sops](https://github.com/Mic92/sops-nix) instead
- ❌️ `darwin-*` or `brew-*` - not needed because no `nix-darwin` configs

The instructions below outline how to perform common operations in this repository, and how they differ from the norm.

## Creating a New NixOS Host Configuration

### Using the Dendritic pattern

To create a definition of a new NixOS host called `example`, at minimum create a `configuration.nix` file in `modules/hosts/example/`.

> NOTE: location and file naming is arbitrary, because of `import-tree` and `flake-parts`, these files can be placed **anywhere** in `modules/`

- `modules/hosts/example/configuration.nix`

    ```nix
    {inputs, ...}: {
      flake.nixosConfigurations = inputs.self.lib.mkNixos "x86_64-linux" "example";
      flake.modules.nixos.example = {pkgs, ...}: {
        imports = [
          # NixOS module imports here...
        ];

        # Hostname
        networking.hostName = "example";

        # other regular NixOS Hardware Configuration file contents here
        home-manager.users."example_user" = {
          imports = [
            # home-manager module mports here...
          ];
          # Normal home-manager config stuff goes here
        };
      };
    }
    ```

You must also add a `hardware-configuration.nix`, which is a file usually automatically generated during the installation of your NixOS host, or generated by the command on an existing host:

```sh
sudo nixos-generate-config --show-hardware-config > modules/hosts/example/hardware-configuration.nix
```

- `modules/hosts/example/hardware-configuration.nix`

    ```nix
    {
      flake.modules.nixos.example = {
        config,
        lib,
        pkgs,
        modulesPath,
        ...
      }: {
        imports = [
            # NixOS module imports here
        ];
        # Normal NixOS Hardware Configuration file contents here
      }
    }
    ```

### Normal Nix Flake

To create a basic configuration for a NixOS host, you usually need to create a Nix module, usually called `configuration.nix`, and reference the automatically generated `hardware-configuration.nix` by path.

- `./hosts/example/configuration.nix`

    ```nix
    {
      inputs,
      pkgs,
      ...
    }: {
      imports = [
        ./hardware-configuration.nix
        # other NixOS module imports here
      ];
      # regular NixOS Configuration file contents here
    }
    ```

- `./hosts/example/hardware-configuration.nix`

    ```nix
    {
      inputs,
      pkgs,
      ...
    }: {
      imports = [
          # NixOS module imports here
      ];
      # regular NixOS Hardware Configuration file contents here
    }
    ```

Additionally, if you're using `home-manager` [as a NixOS module](https://home-manager.dev/manual/25.11/index.xhtml#sec-install-nixos-module), then you need to add that too and point it to a `home-manager` NixOS module, like the one shown below.

- `home/example_user.nix`

    ```nix
    {pkgs, ...}: {
      imports = [
        # home-manager module imports here...
      ];
      # regular home-manager config stuff goes here
    }
    ```

Finally, you also need to add the new host to your `flake.nix`, and specify the paths where the `NixOS` configuration and `home-manager` configurations are.

- `flake.nix`

    ```nix
    {
      inputs = {
        # flake inputs here
      };

      outputs = {
        nixpkgs,
        home-manager,
        ...
      }: {
        # Available through 'nixos-rebuild --flake .#your-hostname'
        nixosConfigurations = {

          # This is our example NixOS host defined below
          example = nixpkgs.lib.nixosSystem {
            system = "x86_64-linux";
            modules = [
              ./hosts/example/configuration.nix
              home-manager.nixosModules.home-manager
              {
                home-manager.users.user = import ./home/example_user.nix;
              }
            ];
          };
        };
      };
    }
    ```

## Installing/Deploying a Host

These are instructions for deploying or freshly installing a NixOS configuration on a computer or virtual machine.

### Using the Dendritic pattern



### Normal Nix Flake